<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Kateaw AR : For Get Me Not 2025</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');

    body, html {
      margin: 0; padding: 0; 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      overflow: hidden; background: black;
    }

    * { font-family: 'Prompt', sans-serif; }

    /* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ß‡πà‡∏ô VR/Fullscreen ‡∏Ç‡∏≠‡∏á A-Frame */
    .a-enter-vr { display: none !important; }

    /* Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡πÇ‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏•‡∏¢‡πå‡πÅ‡∏¢‡∏Å‡∏ä‡∏¥‡πâ‡∏ô */
    #overlay-container {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 99998 !important; 
    }

    /* ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏π‡∏õ‡πÇ‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏•‡∏¢‡πå (‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô CSS ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÉ‡∏à‡∏ä‡∏≠‡∏ö) */
    .overlay-part {
      position: absolute;
      width: 100%; /* ‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
      pointer-events: none;
    }
    .overlay-top { top: 0; left: 0; }
    .overlay-bottom { bottom: 0; left: 0; }

    /* Container ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ */
    #ui-container {
      position: absolute;
      bottom: max(30px, env(safe-area-inset-bottom)); 
      left: 50%; transform: translateX(-50%);
      z-index: 99999 !important; width: 100%; text-align: center;
      pointer-events: none;
    }

    #recordBtn {
      padding: 12px 24px; font-size: 16px; font-weight: bold;
      border-radius: 50px; background-color: #ff3b30;
      color: white; border: none; cursor: pointer;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.5);
      transition: opacity 0.3s;
      pointer-events: auto; 
    }

    /* Dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô */
    #cameraSelect {
      position: absolute;
      top: max(20px, env(safe-area-inset-top)); 
      right: 20px; z-index: 99999 !important;
      padding: 8px 12px; border-radius: 8px;
      background: rgba(0,0,0,0.7); color: white; border: 2px solid white;
      font-size: 14px; cursor: pointer; font-weight: bold;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.5);
      max-width: 150px;
    }
  </style>
</head>

<body>

  <a-scene mindar-image="imageTargetSrc: ./targets.mind;" color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights, preserveDrawingBuffer: true" vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">
    <a-assets>
      <video id="myVideo" src="./video.mp4" preload="auto" loop="true" crossorigin="anonymous" playsinline webkit-playsinline></video>
    </a-assets>
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    <a-entity mindar-image-target="targetIndex: 0">
      <a-video id="arVideoEntity" src="#myVideo" width="1" position="0 0 0" rotation="0 0 0"></a-video>
    </a-entity>
  </a-scene>

  <div id="overlay-container">
    <img class="overlay-part overlay-top" src="./top.png" crossorigin="anonymous" />
    <img class="overlay-part overlay-bottom" src="./bottom.png" crossorigin="anonymous" />
  </div>

  <div id="ui-container">
    <button id="recordBtn">üî¥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div>
  
  <select id="cameraSelect">
    <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...</option>
  </select>

  <script>
    const video = document.querySelector('#myVideo');
    const targetEntity = document.querySelector('[mindar-image-target]');
    const arVideoEntity = document.querySelector('#arVideoEntity');
    const sceneEl = document.querySelector('a-scene');

    video.addEventListener('loadedmetadata', () => {
      const ratio = video.videoHeight / video.videoWidth;
      arVideoEntity.setAttribute('height', 1 * ratio);
    });

    targetEntity.addEventListener("targetFound", event => { video.play(); });
    targetEntity.addEventListener("targetLost", event => { video.pause(); });

    // --- üì∑ ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏ô‡∏™‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ---
    async function loadCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        const select = document.getElementById('cameraSelect');
        select.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î

        if (videoDevices.length === 0) {
          select.style.display = 'none';
          return;
        }

        // ‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á‡πÉ‡∏ô Dropdown
        videoDevices.forEach((device, index) => {
          const option = document.createElement('option');
          option.value = device.deviceId;
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏ô‡∏™‡πå‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‡∏Å‡∏•‡πâ‡∏≠‡∏á 1, ‡∏Å‡∏•‡πâ‡∏≠‡∏á 2
          option.text = device.label || `‡πÄ‡∏•‡∏ô‡∏™‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á ${index + 1}`;
          select.appendChild(option);
        });

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô Dropdown
        select.addEventListener('change', async (e) => {
          const deviceId = e.target.value;
          const webcamVideo = document.querySelector('video:not(#myVideo)'); // ‡∏´‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á AR
          
          if (webcamVideo && webcamVideo.srcObject) {
            // ‡∏õ‡∏¥‡∏î‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô
            webcamVideo.srcObject.getTracks().forEach(track => track.stop());
          }

          // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏° Device ID ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
          const newStream = await navigator.mediaDevices.getUserMedia({
            video: { deviceId: { exact: deviceId } }
          });
          
          if (webcamVideo) {
            webcamVideo.srcObject = newStream;
            webcamVideo.play();
          }
        });
      } catch (err) {
        console.warn("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ", err);
      }
    }

    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö AR ‡∏£‡∏±‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô ‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏ô‡∏™‡πå (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
    sceneEl.addEventListener('arReady', loadCameras);

    // --- üé• ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏•‡∏¢‡πå‡πÅ‡∏¢‡∏Å‡∏ä‡∏¥‡πâ‡∏ô) ---
    const recordBtn = document.getElementById('recordBtn');
    let mediaRecorder;
    let recordedChunks = [];
    let isRecording = false;
    let isProcessingBtn = false; 
    let reqAnimFrameId;

    const compCanvas = document.createElement('canvas');
    const compCtx = compCanvas.getContext('2d');

    function drawCover(ctx, source, srcW, srcH, canvasW, canvasH) {
      if (!srcW || !srcH) return;
      const scale = Math.max(canvasW / srcW, canvasH / srcH);
      const w = srcW * scale;
      const h = srcH * scale;
      const x = (canvasW - w) / 2;
      const y = (canvasH - h) / 2;
      ctx.drawImage(source, x, y, w, h);
    }

    function startRecording() {
      const aCanvas = document.querySelector('.a-canvas');
      const webcamVideo = document.querySelector('video:not(#myVideo)');

      if (!aCanvas || !webcamVideo) {
        alert("‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
      }

      // ‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á Canvas ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏Ñ‡∏£‡∏ä
      const screenRatio = window.innerHeight / window.innerWidth;
      compCanvas.width = 720; 
      compCanvas.height = 720 * screenRatio;

      isRecording = true;
      drawCompositeFrame(webcamVideo, aCanvas);
      recordBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°...";
      
      setTimeout(() => {
        const canvasStream = compCanvas.captureStream(30);
        
        // ‡∏î‡∏∂‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ AR ‡∏°‡∏≤‡∏£‡∏ß‡∏°
        const combinedStream = new MediaStream(canvasStream.getVideoTracks());
        try {
          const captureMethod = video.captureStream || video.mozCaptureStream;
          if (captureMethod) {
            const videoStream = captureMethod.call(video);
            const audioTracks = videoStream.getAudioTracks();
            if (audioTracks.length > 0) {
              combinedStream.addTrack(audioTracks[0]);
            }
          }
        } catch (e) {}

        let options = MediaRecorder.isTypeSupported('video/webm; codecs=vp8, opus') 
          ? { mimeType: 'video/webm; codecs=vp8, opus' }
          : MediaRecorder.isTypeSupported('video/mp4') 
            ? { mimeType: 'video/mp4' } 
            : { mimeType: 'video/webm' };

        try { mediaRecorder = new MediaRecorder(combinedStream, options); } 
        catch (e) { mediaRecorder = new MediaRecorder(combinedStream); }

        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType || 'video/webm' });
          showRecordedVideoUI(URL.createObjectURL(blob), mediaRecorder.mimeType.includes('mp4') ? 'mp4' : 'webm');
          recordedChunks = [];
        };

        mediaRecorder.start();
        recordBtn.innerText = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
        recordBtn.style.backgroundColor = "#8e8e93";
      }, 500); 
    }

    function stopRecording() {
      isRecording = false;
      if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
      cancelAnimationFrame(reqAnimFrameId);
      recordBtn.innerText = "üî¥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
      recordBtn.style.backgroundColor = "#ff3b30";
    }

    function drawCompositeFrame(webcamVideo, aCanvas) {
      if (!isRecording) return;

      compCtx.clearRect(0, 0, compCanvas.width, compCanvas.height);

      // ‡∏ß‡∏≤‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞ AR
      drawCover(compCtx, webcamVideo, webcamVideo.videoWidth, webcamVideo.videoHeight, compCanvas.width, compCanvas.height);
      drawCover(compCtx, aCanvas, aCanvas.width, aCanvas.height, compCanvas.width, compCanvas.height);

      // --- üü¢ ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏•‡∏¢‡πå‡πÅ‡∏¢‡∏Å‡∏ä‡∏¥‡πâ‡∏ô (‡∏Å‡∏µ‡πà‡∏ä‡∏¥‡πâ‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ) ‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
      const overlayContainer = document.getElementById('overlay-container');
      const overlayImgs = overlayContainer.querySelectorAll('img');
      
      // ‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏Å‡∏±‡∏ö ‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏î
      const scaleX = compCanvas.width / window.innerWidth;
      const scaleY = compCanvas.height / window.innerHeight;

      overlayImgs.forEach(img => {
        if (img.complete && img.naturalHeight !== 0) {
          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á CSS ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
          const rect = img.getBoundingClientRect();
          // ‡∏ß‡∏≤‡∏î‡∏•‡∏á Canvas ‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πä‡∏∞‡πÜ
          compCtx.drawImage(
            img, 
            rect.left * scaleX, 
            rect.top * scaleY, 
            rect.width * scaleX, 
            rect.height * scaleY
          );
        }
      });

      reqAnimFrameId = requestAnimationFrame(() => drawCompositeFrame(webcamVideo, aCanvas));
    }

    function showRecordedVideoUI(videoUrl, fileExtension) {
      const popup = document.createElement('div');
      popup.style.position = 'fixed';
      popup.style.top = '0'; popup.style.left = '0';
      popup.style.width = '100vw'; popup.style.height = '100vh';
      popup.style.backgroundColor = 'rgba(0,0,0,0.95)';
      popup.style.zIndex = '999999'; 
      popup.style.display = 'flex';
      popup.style.flexDirection = 'column';
      popup.style.justifyContent = 'center';
      popup.style.alignItems = 'center';

      popup.innerHTML = `
        <h3 style="color: white; margin-bottom: 10px; font-family: 'Prompt', sans-serif;">‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</h3>
        <video src="${videoUrl}" controls autoplay loop style="max-width: 90%; max-height: 60vh; border: 2px solid white; border-radius: 10px;"></video>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <a href="${videoUrl}" download="Congrast-AR.${fileExtension}" style="background: #007aff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 50px; font-weight: bold; font-family: 'Prompt', sans-serif;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</a>
          <button id="closePopupBtn" style="background: #ff3b30; color: white; padding: 12px 24px; border: none; border-radius: 50px; font-weight: bold; font-size: 16px; cursor: pointer; font-family: 'Prompt', sans-serif;">‚ùå ‡∏õ‡∏¥‡∏î</button>
        </div>
      `;
      document.body.appendChild(popup);
      document.getElementById('closePopupBtn').addEventListener('click', () => {
        document.body.removeChild(popup);
        URL.revokeObjectURL(videoUrl);
      });
    }

    recordBtn.addEventListener('click', () => {
      if (isProcessingBtn) return;
      isProcessingBtn = true;
      recordBtn.style.opacity = "0.6"; 
      if (isRecording) stopRecording(); else startRecording();
      setTimeout(() => { isProcessingBtn = false; recordBtn.style.opacity = "1"; }, 1000);
    });

  </script>
</body>
</html>