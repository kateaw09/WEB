<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Kateaw AR : For Get Me Not 2025</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');

    body, html {
      margin: 0; padding: 0; overflow: hidden;
    }

    * {
      font-family: 'Prompt', sans-serif;
    }

    /* ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ 100% ‡πÅ‡∏ó‡∏ô 100vh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    #overlay-container {
      position: absolute;
      top: 0; left: 0; width: 100vw; height: 100%;
      pointer-events: none; z-index: 10;
    }

    #ui-container {
      position: absolute;
      bottom: 30px; left: 50%;
      transform: translateX(-50%);
      z-index: 20;
    }

    #recordBtn {
      padding: 12px 24px; font-size: 16px; font-weight: bold;
      border-radius: 50px; background-color: #ff3b30;
      color: white; border: none; cursor: pointer;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
      transition: opacity 0.3s;
    }
  </style>
</head>

<body>

  <a-scene mindar-image="imageTargetSrc: ./targets.mind;" color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights, preserveDrawingBuffer: true" vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <video id="myVideo" src="./video.mp4" preload="auto" loop="true" crossorigin="anonymous" playsinline
        webkit-playsinline></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-video id="arVideoEntity" src="#myVideo" width="1" position="0 0 0" rotation="0 0 0"></a-video>
    </a-entity>

  </a-scene>

  <div id="overlay-container">
    <img id="overlay-top" src="./top.png" crossorigin="anonymous"
      style="position: absolute; top: 0; left: 0; width: 70%; max-width: 450px;" />

    <img id="overlay-bottom" src="./bottom.png" crossorigin="anonymous"
      style="position: absolute; bottom: 0; right: 0; width: 70%; max-width: 450px;" />
  </div>

  <div id="ui-container">
    <button id="recordBtn">üî¥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div>

  <script>
    const video = document.querySelector('#myVideo');
    const targetEntity = document.querySelector('[mindar-image-target]');
    const arVideoEntity = document.querySelector('#arVideoEntity');

    video.addEventListener('loadedmetadata', () => {
      const ratio = video.videoHeight / video.videoWidth;
      arVideoEntity.setAttribute('height', 1 * ratio);
    });

    targetEntity.addEventListener("targetFound", event => {
      video.play();
    });

    targetEntity.addEventListener("targetLost", event => {
      video.pause();
    });

    const recordBtn = document.getElementById('recordBtn');
    let mediaRecorder;
    let recordedChunks = [];
    let isRecording = false;
    let isProcessingBtn = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Debounce
    let reqAnimFrameId;

    const compCanvas = document.createElement('canvas');
    const compCtx = compCanvas.getContext('2d');

    function startRecording() {
      const aCanvas = document.querySelector('.a-canvas');
      const webcamVideo = document.querySelector('video:not(#myVideo)');

      if (!aCanvas || !webcamVideo) {
        alert("‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
      }

      compCanvas.width = aCanvas.width;
      compCanvas.height = aCanvas.height;

      const canvasStream = compCanvas.captureStream(30);

      let audioTracks = [];
      try {
        const captureMethod = video.captureStream || video.mozCaptureStream;
        if (captureMethod) {
          const videoStream = captureMethod.call(video);
          audioTracks = videoStream.getAudioTracks();
        }
      } catch (e) {
        console.warn("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÑ‡∏î‡πâ: ", e);
      }

      const combinedStream = new MediaStream([
        ...canvasStream.getVideoTracks(),
        ...audioTracks
      ]);

      let options;
      let fileExtension = 'webm';

      if (MediaRecorder.isTypeSupported('video/mp4; codecs="avc1.42E01E, mp4a.40.2"')) {
        options = { mimeType: 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"' };
        fileExtension = 'mp4';
      } else if (MediaRecorder.isTypeSupported('video/mp4')) {
        options = { mimeType: 'video/mp4' };
        fileExtension = 'mp4';
      } else if (MediaRecorder.isTypeSupported('video/webm; codecs=vp9, opus')) {
        options = { mimeType: 'video/webm; codecs=vp9, opus' };
        fileExtension = 'webm';
      } else if (MediaRecorder.isTypeSupported('video/webm')) {
        options = { mimeType: 'video/webm' };
        fileExtension = 'webm';
      } else {
        options = {};
      }

      try {
        mediaRecorder = new MediaRecorder(combinedStream, options);
      } catch (e) {
        mediaRecorder = new MediaRecorder(combinedStream);
      }

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType || 'video/mp4' });
        const url = URL.createObjectURL(blob);
        showRecordedVideoUI(url, fileExtension);
        recordedChunks = [];
      };

      mediaRecorder.start();
      isRecording = true;
      recordBtn.innerText = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
      recordBtn.style.backgroundColor = "#8e8e93";

      drawCompositeFrame(webcamVideo, aCanvas);
    }

    function stopRecording() {
      isRecording = false;
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      cancelAnimationFrame(reqAnimFrameId);
      recordBtn.innerText = "üî¥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
      recordBtn.style.backgroundColor = "#ff3b30";
    }

    function drawCompositeFrame(webcamVideo, aCanvas) {
      if (!isRecording) return;

      compCtx.clearRect(0, 0, compCanvas.width, compCanvas.height);

      // 1. ‡∏ß‡∏≤‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
      const scaleWebcam = Math.max(compCanvas.width / webcamVideo.videoWidth, compCanvas.height / webcamVideo.videoHeight);
      const wWebcam = webcamVideo.videoWidth * scaleWebcam;
      const hWebcam = webcamVideo.videoHeight * scaleWebcam;
      const xWebcam = (compCanvas.width - wWebcam) / 2;
      const yWebcam = (compCanvas.height - hWebcam) / 2;
      compCtx.drawImage(webcamVideo, xWebcam, yWebcam, wWebcam, hWebcam);

      // 2. ‡∏ß‡∏≤‡∏î AR
      compCtx.drawImage(aCanvas, 0, 0, compCanvas.width, compCanvas.height);

      // 3. ‡∏ß‡∏≤‡∏î Overlay ‡πÅ‡∏ö‡∏ö‡∏¢‡∏∂‡∏î‡∏ï‡∏¥‡∏î‡∏°‡∏∏‡∏° Canvas (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏ï‡∏Å‡∏Ç‡∏≠‡∏ö)
      const topImg = document.getElementById('overlay-top');
      const bottomImg = document.getElementById('overlay-bottom');

      const drawOverlayPinned = (imgElement, position) => {
        if (imgElement && imgElement.complete && imgElement.naturalHeight !== 0) {
          // ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö Canvas
          const scale = compCanvas.width / window.innerWidth;
          const rect = imgElement.getBoundingClientRect();
          
          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏≤‡∏î‡∏•‡∏á Canvas ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡πÄ‡∏´‡πá‡∏ô
          const drawWidth = rect.width * scale;
          const drawHeight = rect.height * scale;

          if (position === 'top-left') {
            // ‡∏¢‡∏∂‡∏î‡∏ï‡∏¥‡∏î‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô
            compCtx.drawImage(imgElement, 0, 0, drawWidth, drawHeight);
          } else if (position === 'bottom-right') {
            // ‡∏¢‡∏∂‡∏î‡∏ï‡∏¥‡∏î‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á ‡πÇ‡∏î‡∏¢‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á/‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á Canvas ‡∏ï‡∏±‡πâ‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ
            const x = compCanvas.width - drawWidth;
            const y = compCanvas.height - drawHeight;
            compCtx.drawImage(imgElement, x, y, drawWidth, drawHeight);
          }
        }
      };

      drawOverlayPinned(topImg, 'top-left');
      drawOverlayPinned(bottomImg, 'bottom-right');

      reqAnimFrameId = requestAnimationFrame(() => drawCompositeFrame(webcamVideo, aCanvas));
    }

    // Popup UI
    function showRecordedVideoUI(videoUrl, fileExtension) {
      const popup = document.createElement('div');
      popup.style.position = 'fixed';
      popup.style.top = '0'; popup.style.left = '0';
      popup.style.width = '100vw'; popup.style.height = '100vh';
      popup.style.backgroundColor = 'rgba(0,0,0,0.95)';
      popup.style.zIndex = '9999';
      popup.style.display = 'flex';
      popup.style.flexDirection = 'column';
      popup.style.justifyContent = 'center';
      popup.style.alignItems = 'center';

      popup.innerHTML = `
        <h3 style="color: white; margin-bottom: 10px; font-family: 'Prompt', sans-serif;">‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
        <video src="${videoUrl}" controls autoplay loop style="max-width: 90%; max-height: 60vh; border: 2px solid white; border-radius: 10px;"></video>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <a href="${videoUrl}" download="FroGetMeNot2025-Kateaw.${fileExtension}" style="background: #007aff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 50px; font-weight: bold; font-family: 'Prompt', sans-serif;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</a>
          <button id="closePopupBtn" style="background: #ff3b30; color: white; padding: 12px 24px; border: none; border-radius: 50px; font-weight: bold; font-size: 16px; cursor: pointer; font-family: 'Prompt', sans-serif;">‚ùå ‡∏õ‡∏¥‡∏î</button>
        </div>
        <p style="color: #aaa; font-size: 12px; margin-top: 15px; font-family: 'Prompt', sans-serif; text-align: center; padding: 0 20px;">
          *‡∏ö‡∏ô iPhone ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å<br>"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠" ‡∏´‡∏£‡∏∑‡∏≠ "Save Video"*
        </p>
      `;

      document.body.appendChild(popup);

      document.getElementById('closePopupBtn').addEventListener('click', () => {
        document.body.removeChild(popup);
        URL.revokeObjectURL(videoUrl);
      });
    }

    // Event ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö Debounce ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡πÄ‡∏ö‡∏¥‡πâ‡∏•)
    recordBtn.addEventListener('click', () => {
      // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
      if (isProcessingBtn) return;

      isProcessingBtn = true;
      recordBtn.style.opacity = "0.6"; // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏á‡∏•‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß

      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }

      // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      setTimeout(() => {
        isProcessingBtn = false;
        recordBtn.style.opacity = "1";
      }, 1000);
    });

  </script>
</body>
</html>